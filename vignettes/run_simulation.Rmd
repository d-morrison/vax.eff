---
title: "Results"
# output: word_document
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{run_simulation}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  echo = FALSE,
  comment = "#>"
)
library(vax.eff)
library(tidyverse)
library(magrittr)
library(pander)
library(xtable)
library(purrr)
library(ggplot2)
library(tibble)
library(latex2exp)
library(janitor)
library(scales)

```

## Figure 1

Relationship of bias factor $K = R^*/R$, linkage probability $P_L$, and vaccination reporting probability,
given $P(V^*) = 0.5$ and $R = 0.25$.

```{r, fig.width=6, fig.height=4}
# fig.width=6, fig.height=4, dpi=300
`pV*` = 0.5
R = 0.25

f1 = function(pL, rV) 
{
  reporting_multiplier(
    `p(V)` = `pV*`/ rV,
    `p(E|!V)` = NA,
    R = R,
    `p(V*|V)` = rV,
    `p(E*|E)` = NA,
    `p(L|V*E*)` = pL) %>% pull(`R*/R`)
  
}

plot1 = ggplot() +
  xlim(0.5,1) +
  expand_limits(y = 0) +
  geom_function(aes(col = "0.6"), fun = function(x) f1(x, rV = 0.6)) +
  geom_function(aes(col = "0.7"), fun = function(x) f1(x, rV = 0.7)) +
  geom_function(aes(col = "0.8"), fun = function(x) f1(x, rV = 0.8)) +
  geom_function(aes(col = "0.9"), fun = function(x) f1(x, rV = 0.9)) +
  geom_function(aes(col = "1.0"), fun = function(x) f1(x, rV = 1.0)) +
  theme_bw() +
  xlab(latex2exp::TeX("p_L = Pr(Records Linked | Event and Vaccine Recorded)")) +
  ylab(latex2exp::TeX("K = R^*/R")) +
  # abline(h = 0, col = "black") +
  labs(color = latex2exp::TeX("r_V"))


print(plot1)


```

## Table 1

```{r, include = FALSE}

pV = .75
rD = .9
rV = .9
`N*` = 11 * 10^6

all_results = gen_tab1(`p(V)` = pV, `p(E*|E)` = rD, `p(V*|V)` = rV, `mu(N*)` = `N*`,
                       `R` = c(1, .25),
                       `p(L|V*E*)` = c(.95, .9, .7))

```

Simulation results with $P(V) = `r pV`$, $r_D = `r rD`$, $r_V = `r rV`$, and $N^* = N = 11 * 10^6$:

```{r, results = 'asis'}

knitr::kable(all_results, format = "markdown")

```


## Table 2

```{r, include = FALSE}

pV = .75
rD = .7
rV = .9
`N*` = 11 * 10^6

all_results = gen_tab1(pV = pV, rD = rD, rV = rV, `mu(N*)` = `N*`,
                       `R` = c(1, .25),
                       `p(L|V*E*)` = c(.95, .9, .7))
```

Simulation results with $P(V) = `r pV`$, $r_D = `r rD`$, $r_V = `r rV`$, and $N^* = N = 11 * 10^6$:

```{r, results = 'asis'}
knitr::kable(all_results, format = "markdown")
```


## Table 3

```{r, include = FALSE}

pV = .75
rD = .9
rV = .9
R = .25
pL = .9
multiplier = c(1.2, 1.1, 1.05, 1, .95, .9, .8)
`N*` = 11 * 10^6 * multiplier

all_results = gen_tab1(pV = pV, rD = rD, rV = rV, `mu(N*)` = `N*`,
                       `R` = R,
                       `p(L|V*E*)` = pL) %>%
  rename(`$N^*$` = `$mu(N*)$`) %>%
  mutate(`$N^*$` = scales::number(`$N^*$`, big.mark = ","))

all_results = bind_cols(
  "$N^*/N$" = multiplier,
  all_results
)

```

Simulation results for varying $N^*$ (with $P(V) = `r pV`$, $r_D = `r rD`$, $r_V = `r rV`$, $P_L = `r pL`$, $R = `r R`$):

```{r, results = 'asis'}
knitr::kable(all_results, format = "markdown")
```

Note: we haven't worked out yet how $N^* \ne N$ affects $K$.
